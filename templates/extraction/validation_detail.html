{#template/extraction/validation_detail.html#}
{% extends 'base.html' %}

{% block title %}Validation Métadonnées - {{ document.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <button class="btn btn-outline-secondary me-3" onclick="history.back()">
                        <i class="bi bi-arrow-left me-2"></i>Retour
                    </button>
                    <h2 class="h4 mb-0">
                        <i class="bi bi-check-circle me-2"></i>Validation Métadonnées
                    </h2>
                </div>
                <div>
                    <button class="btn btn-outline-secondary" onclick="showAudit()">
                        <i class="bi bi-clock-history me-2"></i>Afficher l'audit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Métadonnées du Document -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-text me-2 text-warning"></i>
                        Métadonnées extraites par IA
                    </h5>
                </div>
                <div class="card-body">
                    <form id="metadataForm">
                        {% csrf_token %}
                        
                        <!-- Titre du document -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">Titre du document</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="{{ extracted_data.title }}" 
                                           id="titleField" autocomplete="off">
                                    {% if extracted_data.title and extracted_data.title != document.title %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-extrait
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark d-flex align-items-center">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Manuel
                                    </span>
                                    {% endif %}
                                </div>
                                {% if extracted_data.title and extracted_data.title != document.title %}
                                <small class="text-muted">
                                    <i class="bi bi-robot me-1"></i>
                                    Extrait automatiquement par IA
                                    <span class="badge bg-info ms-2">
                                        {{ confidence_scores.title|default:"0" }}%
                                    </span>
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Type et Contexte -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Type de document</label>
                                <div class="input-group">
                                    <select class="form-select" id="typeField">
                                        <option value="guideline" {% if extracted_data.document_type == 'guideline' %}selected{% endif %}>Guideline</option>
                                        <option value="rapport" {% if extracted_data.document_type == 'rapport' %}selected{% endif %}>Rapport</option>
                                        <option value="image" {% if extracted_data.document_type == 'image' %}selected{% endif %}>Image</option>
                                        <option value="article" {% if extracted_data.document_type == 'article' %}selected{% endif %}>Article</option>
                                        <option value="manuel" {% if extracted_data.document_type == 'manuel' %}selected{% endif %}>Manuel</option>
                                    </select>
                                    {% if extracted_data.document_type %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-détecté
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.document_type %}
                                <small class="text-muted">
                                   Confiance: {{ confidence_scores.document_type }}%
                                </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Contexte du document</label>
                                <div class="input-group">
                                    <select class="form-select" id="contextField">
                                        <option value="pharmaceutique" {% if extracted_data.context == 'pharmaceutique' %}selected{% endif %}>Pharmaceutique</option>
                                        <option value="technique" {% if extracted_data.context == 'technique' %}selected{% endif %}>Technique</option>
                                        <option value="biologie" {% if extracted_data.context == 'biologie' %}selected{% endif %}>Biologie</option>
                                        <option value="medical" {% if extracted_data.context == 'medical' %}selected{% endif %}>Médical</option>
                                        <option value="legal" {% if extracted_data.context == 'legal' %}selected{% endif %}>Légal</option>
                                    </select>
                                    {% if extracted_data.context %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-détecté
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.context %}
                                <small class="text-muted">
                                    Confiance: {{ confidence_scores.context }}%
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Langue et Date -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Langue</label>
                                <div class="input-group">
                                    <select class="form-select" id="languageField">
                                        <option value="fr" {% if extracted_data.language == 'fr' %}selected{% endif %}>Français</option>
                                        <option value="en" {% if extracted_data.language == 'en' %}selected{% endif %}>Anglais</option>
                                        <option value="es" {% if extracted_data.language == 'es' %}selected{% endif %}>Espagnol</option>
                                        <option value="de" {% if extracted_data.language == 'de' %}selected{% endif %}>Allemand</option>
                                        <option value="it" {% if extracted_data.language == 'it' %}selected{% endif %}>Italien</option>
                                    </select>
                                    {% if extracted_data.language %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-détecté
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.language %}
                                <small class="text-muted">
                                    <i class="bi bi-robot me-1"></i>
                                    Détecté: {{ extracted_data.language|upper }}
                                    ({{ confidence_scores.language }}%)
                                </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Date de publication</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" 
                                           value="{{ extracted_data.publication_date|default:document.publication_date|date:'Y-m-d' }}" 
                                           id="dateField" autocomplete="off">
                                    {% if extracted_data.publication_date %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-extrait
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.publication_date %}
                                <small class="text-muted">
                                    <i class="bi bi-robot me-1"></i>
                                    Confiance: {{ confidence_scores.publication_date }}%
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Version et Source -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Version</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="{{ extracted_data.version|default:'' }}"
                                           placeholder="{% if not extracted_data.version %}Version non détectée{% endif %}" 
                                           id="versionField" autocomplete="off">
                                    {% if extracted_data.version %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-extrait
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary d-flex align-items-center">
                                        <i class="bi bi-question-circle me-1"></i>Non trouvé
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.version %}
                                <small class="text-muted">
                                    Confiance: {{ confidence_scores.version }}%
                                </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Source</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="{{ extracted_data.source|default:document.source }}" 
                                           id="sourceField"
                                           placeholder="Organisation/source" autocomplete="off">
                                    {% if extracted_data.source %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-extrait
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.source %}
                                <small class="text-muted">
                                    <i class="bi bi-robot me-1"></i>
                                    Confiance: {{ confidence_scores.source }}%
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- URL source -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-semibold">URL source</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" 
                                           value="{{ extracted_data.source_url|default:'' }}" 
                                           id="urlField"
                                           placeholder="{% if not extracted_data.source_url %}URL non détectée{% endif %}" autocomplete="off">
                                    {% if extracted_data.source_url %}
                                    <span class="badge bg-success d-flex align-items-center">
                                        <i class="bi bi-robot me-1"></i>Auto-extrait
                                    </span>
                                    <a href="{{ extracted_data.source_url }}" target="_blank" class="btn btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                    {% else %}
                                    <span class="badge bg-secondary d-flex align-items-center">
                                        <i class="bi bi-question-circle me-1"></i>Non trouvé
                                    </span>
                                    {% endif %}
                                </div>
                                {% if confidence_scores.source_url %}
                                <small class="text-muted">
                                    Confiance: {{ confidence_scores.source_url }}%
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ==== Champs EMA ajoutés - CORRIGÉS ==== -->
                        <hr>
                        <h5>Informations EMA</h5>

                        <!-- Dates EMA inversées dans le template -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="originalPublicationDate" class="form-label fw-semibold">Première publication EMA</label>
                                <input type="date" class="form-control" id="originalPublicationDate" value="{{ ema_data.ema_publication_date|default_if_none:'' }}" autocomplete="off">
                            </div>
                            <div class="col-md-6">
                                <label for="emaPublicationDate" class="form-label fw-semibold">Dernière mise à jour EMA</label>
                                <input type="date" class="form-control" id="emaPublicationDate" value="{{ ema_data.original_publication_date|default_if_none:'' }}" autocomplete="off">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="emaTitle" class="form-label fw-semibold">Titre EMA</label>
                            <input type="text" class="form-control" id="emaTitle" value="{{ ema_data.ema_title|default_if_none:'' }}" autocomplete="off">
                        </div>

                        <div class="mb-3">
                            <label for="emaReference" class="form-label fw-semibold">Référence EMA</label>
                            <input type="text" class="form-control" id="emaReference" value="{{ ema_data.ema_reference|default_if_none:'' }}" autocomplete="off">
                        </div>

                        <div class="mb-3">
                            <label for="emaSourceUrl" class="form-label fw-semibold">URL source EMA</label>
                            <input type="url" class="form-control" id="emaSourceUrl" value="{{ ema_data.ema_source_url|default_if_none:'' }}" autocomplete="off">
                        </div>

                        <!-- Boutons d'action -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                                        <i class="bi bi-arrow-left me-2"></i>Retour
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="saveMetadata()">
                                        <i class="bi bi-check-lg me-2"></i>Sauvegarder et valider
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="reExtract()">
                                        <i class="bi bi-arrow-repeat me-2"></i>Réextraire
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Qualité d'Extraction et Audit -->
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-cpu me-2 text-primary"></i>Qualité d'Extraction IA
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold">Taux global d'extraction:</span>
                            <span class="h4 mb-0">{{ confidence_score_global }}%</span>
                        </div>
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar 
                                {% if confidence_score_global >= 80 %}bg-success
                                {% elif confidence_score_global >= 50 %}bg-warning
                                {% else %}bg-danger{% endif %}" 
                                style="width: {{ confidence_score_global }}%"></div>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Extraction effectuée le {{ extraction_result.created_at|date:"d/m/Y à H:i" }}
                        </small>
                    </div>

                    <div class="mb-3">
                        <h6 class="fw-semibold mb-2">Champs extraits automatiquement:</h6>
                        <div class="d-flex flex-wrap gap-1">
                            {% for field, value in extracted_data.items %}
                                {% if value %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check me-1"></i>{{ field|title }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-x me-1"></i>{{ field|title }}
                                </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div>
                        <h6 class="fw-semibold mb-2">Scores de confiance détaillés:</h6>
                        <div class="small">
                            {% for field, score in confidence_scores.items %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>{{ field|cut:"_"|title }}:</span>
                                <span class="confidence-score 
                                    {% if score >= 80 %}confidence-high text-success
                                    {% elif score >= 50 %}confidence-medium text-warning
                                    {% else %}confidence-low text-danger{% endif %}">
                                    {{ score }}%
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extraction Automatique Brute -->
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-code-square me-2 text-info"></i>Données extraites par IA
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        {% if extracted_data.title %}
                        <div class="mb-2"><strong>Titre:</strong> {{ extracted_data.title|truncatechars:50 }}</div>
                        {% endif %}
                        {% if extracted_data.document_type %}
                        <div class="mb-2"><strong>Type:</strong> {{ extracted_data.document_type|title }}</div>
                        {% endif %}
                        {% if extracted_data.context %}
                        <div class="mb-2"><strong>Contexte:</strong> {{ extracted_data.context|title }}</div>
                        {% endif %}
                        {% if extracted_data.publication_date %}
                        <div class="mb-2"><strong>Date:</strong> {{ extracted_data.publication_date }}</div>
                        {% endif %}
                        {% if extracted_data.language %}
                        <div class="mb-2"><strong>Langue:</strong> {{ extracted_data.language|upper }}</div>
                        {% endif %}
                        {% if extracted_data.source %}
                        <div class="mb-2"><strong>Source:</strong> {{ extracted_data.source }}</div>
                        {% endif %}
                        {% if extracted_data.version %}
                        <div class="mb-2"><strong>Version:</strong> {{ extracted_data.version }}</div>
                        {% endif %}
                    </div>
                    
                    <button class="btn btn-sm btn-outline-info mt-2" onclick="showRawData()">
                        <i class="bi bi-code me-1"></i>Voir JSON brut
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Trail (masqué par défaut) -->
    <div class="row mt-4" id="auditSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>Audit Trail & Traçabilité
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="d-flex mb-3 p-3 bg-light rounded">
                            <div class="me-3">
                                <span class="badge bg-info">
                                    <i class="bi bi-upload"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">Document uploadé</div>
                                <div class="small text-muted">{{ document.title }}</div>
                                <div class="small text-muted">
                                    <i class="bi bi-person me-1"></i>
                                    {% if document.assigned_to.get_full_name %}
                                        {{ document.assigned_to.get_full_name }}
                                    {% else %}
                                        {{ document.assigned_to.username }}
                                    {% endif %}

                                    <i class="bi bi-clock ms-3 me-1"></i>{{ document.created_at|date:"d/m/Y H:i" }}
                                </div>
                            </div>
                        </div>

                        {% if extraction_result %}
                        <div class="d-flex mb-3 p-3 bg-warning bg-opacity-10 rounded">
                            <div class="me-3">
                                <span class="badge bg-warning">
                                    <i class="bi bi-cpu"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">Extraction IA des métadonnées</div>
                                <div class="small text-muted">
                                    Confiance globale: {{ confidence_score_global }}%
                                </div>
                                <div class="small text-muted">
                                    <i class="bi bi-robot me-1"></i>Intelligence Artificielle
                                    <i class="bi bi-clock ms-3 me-1"></i>{{ extraction_result.created_at|date:"d/m/Y H:i" }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if document.status == 'validated' %}
                        <div class="d-flex mb-3 p-3 bg-success bg-opacity-10 rounded">
                            <div class="me-3">
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">Métadonnées validées</div>
                                <div class="small text-muted">Validation manuelle des données extraites</div>
                                <div class="small text-muted">
                                    <i class="bi bi-person me-1"></i>{{ user.get_full_name|default:user.username }}
                                    <i class="bi bi-clock ms-3 me-1"></i>Maintenant
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour données brutes -->
    <div class="modal fade" id="rawDataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-code-square me-2"></i>Données brutes d'extraction
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre><code id="rawDataContent">{{ extracted_data|pprint }}</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const documentId = {{ document.id }};
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

function showAudit() {
    const auditSection = document.getElementById('auditSection');
    auditSection.style.display = auditSection.style.display === 'none' ? 'block' : 'none';
}

function showRawData() {
    const modal = new bootstrap.Modal(document.getElementById('rawDataModal'));
    modal.show();
}

function reExtract() {
    if (confirm('🤖 Êtes-vous sûr de vouloir relancer l\'extraction IA des métadonnées ? Cela remplacera les données actuelles.')) {
        showAlert('info', '🔄 Extraction IA en cours...');
        
        fetch(`/extraction/re-extract/${documentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', '✅ Extraction IA relancée avec succès');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert('danger', '❌ Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('danger', '❌ Erreur lors de la ré-extraction');
        });
    }
}

function saveMetadata() {
    const formData = {
        title: document.getElementById('titleField').value,
        document_type: document.getElementById('typeField').value,
        context: document.getElementById('contextField').value,
        language: document.getElementById('languageField').value,
        publication_date: document.getElementById('dateField').value,
        version: document.getElementById('versionField').value,
        source: document.getElementById('sourceField').value,
        source_url: document.getElementById('urlField').value,

        original_publication_date: document.getElementById('emaPublicationDate').value,  // intentionnellement inversé
        ema_publication_date: document.getElementById('originalPublicationDate').value,  // intentionnellement inversé
        ema_title: document.getElementById('emaTitle').value,
        ema_reference: document.getElementById('emaReference').value,
        ema_source_url: document.getElementById('emaSourceUrl').value,
    };

    showAlert('info', '💾 Sauvegarde en cours...');

    fetch(`/extraction/save-metadata/${documentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', '✅ Métadonnées sauvegardées et validées avec succès');
            setTimeout(() => {
                window.location.href = '/extraction/validation/';
            }, 2000);
        } else {
            showAlert('danger', '❌ Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert('danger', '❌ Erreur lors de la sauvegarde');
    });
}

function goBack() {
    window.location.href = '/extraction/validation/';
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

<style>
.confidence-high { font-weight: bold; }
.confidence-medium { font-weight: 600; }
.confidence-low { font-weight: normal; }

.badge {
    font-size: 0.75em;
}

pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
}

.timeline .badge {
    min-width: 40px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}
</style>

{% csrf_token %}
{% endblock %}
